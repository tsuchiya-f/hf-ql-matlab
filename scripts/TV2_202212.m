%------------------------------------------------------------------------------------
% User inputs
%------------------------------------------------------------------------------------
st_ctl_in.raw_ver1_corrected = 1;
st_ctl_in.title = 'TV2';
st_ctl_in.ylim = [-90 -10];
st_ctl_in.xlim = [0 45];
st_ctl_in.cf = -104.1;
st_ctl.power_unit = 'dBm@ADCin';

basedir_in = "E:\JUICE\system_test\TV2-Complete\";
basedir_out = "C:\share\Linux\RESULTS\report_TV2\";

 indir  = [ ...
           "2022_12_11T14_03_19_leal197_ded31615_RT_TV2_S7_PH_3_1\RPW1\" ...
           "2022_12_11T14_03_19_leal197_ded31615_RT_TV2_S7_PH_3_1\RPW2\" ...
           "2022_12_11T14_03_19_leal197_ded31615_RT_TV2_S7_PH_3_1\RPW3\" ...
           "2022_12_11T14_03_19_leal197_ded31615_RT_TV2_S7_PH_3_1\RPW4\" ...
           "2022_12_12T09_40_26_basa185_ded31615_RT_TV2_S8_PH3_2\CFDP\" ...
           "2022_12_12T22_50_19_basa185_ded31615_RT_TV2_S9_PH3_2\CFDP\" ...
           "2022_12_13T20_24_02_basa185_ded31615_RT_TV2_S11_PH4\1RPI\" ...
           "2022_12_13T20_24_02_basa185_ded31615_RT_TV2_S11_PH4\1RPR\" ...
           "2022_12_13T20_24_02_basa185_ded31615_RT_TV2_S11_PH4\2RPI\" ...
           "2022_12_13T20_24_02_basa185_ded31615_RT_TV2_S11_PH4\2RPR\" ...
           "2022_12_15T02_14_00_leal197_ded31615_RT_TV2_S14_PH5_1\RPW1\" ...
           "2022_12_15T02_14_00_leal197_ded31615_RT_TV2_S14_PH5_1\RPW2\" ...
           "2022_12_15T02_14_00_leal197_ded31615_RT_TV2_S14_PH5_1\RPW3\" ...
           "2022_12_15T02_14_00_leal197_ded31615_RT_TV2_S14_PH5_1\RPW4\" ...
           "2022_12_17T05_55_05_roma372_ded31615_RT_TV2_S19_PH6\RPW1\" ...
           "2022_12_17T05_55_05_roma372_ded31615_RT_TV2_S19_PH6\RPW3\" ...
           "2022_12_17T05_55_05_roma372_ded31615_RT_TV2_S19_PH6\RPW4\" ...
           ];
 outdir = [ ...
           "Phase3_1_RPW1\" "Phase3_1_RPW2\" "Phase3_1_RPW3\" "Phase3_1_RPW4\" ...
           "S8_Phase3_2\" ...
           "S9_Phase3_2\" ...
           "Phase4_1RPI\" "Phase4_1RPR\" "Phase4_2RPI\" "Phase4_2RPR\" ...
           "Phase5_RPW1\" "Phase5_RPW2\" "Phase5_RPW3\" "Phase5_RPW4\" ...
           "Phase6_RPW1\" "Phase6_RPW3\" "Phase6_RPW4\" ...
           ];
file_search_str = [ ...
    "*" "*" "*" "*" ...
    "*.data" ...
    "*.data" ...
    "*" "*" "*" "*" ...
    "*" "*" "*" "*" ...
    "*" "*" "*" ...
    ];
%------------------------------------------------------------------------------------

ql=0;
st_ctl_in.timeout=5;

n_dir = numel(indir);
for j=1: n_dir

    tdir = append(basedir_out, outdir(j)); 
    mkdir(tdir)

    s = dir(append(basedir_in, indir(j), file_search_str(j)));
    n_file = numel(s);

    for i=1: n_file

        if s(i).bytes > 0

            file = s(i).name;

            infile = append(basedir_in, indir(j), file);
            outfile = append(basedir_out, outdir(j), file, '.hf.ccsds');
            [ret, st_ctl] = hf_get_packet(infile, outfile);

            if ret == 1 
                fprintf("HF data in %s\n", file);
%                fprintf("   SW ver : %d\n", st_ctl.ver);
                fprintf("   number of HF packet      : %d\n",st_ctl.n_pkt);
                fprintf("   number of HF data [Byte] : %d\n",st_ctl.out_sz);

                st_ctl_in.dir_in = append(basedir_in, indir(j));
                st_ctl_in.dir_out = append(basedir_out, outdir(j));
                st_ctl_in.file_in = file;
                [st_ctl_in] = hf_ccsds_ql(ql, st_ctl_in);

            else
                fprintf("No HF data in %s\n", file);
            end
        end
        
    end
end
